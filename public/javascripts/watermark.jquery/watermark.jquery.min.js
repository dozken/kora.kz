(function(e){e.fn.watermark=function(t){var n=this,r={},i={},s=[],o="watermark",u="brightWatermark",a="darkWatermark",f=false,l="bottom-right",c="watermark.png?"+ +(new Date),h=255/(100/50),p=function(){r=e('<canvas style="display:none"></canvas>');i=r[0].getContext("2d");e("body").append(r)},d=function(){var e=f[0].naturalWidth,t=f[0].naturalHeight;setCanvasSize(e,t);i.drawImage(f[0],0,0);var n=i.getImageData(0,0,e,t);var s=n.data,o=s.length;for(var u=3;u<o;u+=4){s[u]=s[u]<h?s[u]:h}n.data=s;i.putImageData(n,0,0);f[0].onload=null;f.attr("src","");f.attr("src",r[0].toDataURL());f.width(e);f.height(t)},v=function(e){if(e){if(e["watermark"])f=e["watermark"];if(e["path"])c=e["path"];if(e["position"])l=e["position"];if(e["opacity"])h=255/(100/e["opacity"]);if(e["className"])o=e["className"];if(e["brightWatermark"])u=e["brightWatermark"];if(e["darkWatermark"])a=e["darkWatermark"]}p();applyWatermarks()};setCanvasSize=function(e,t){r[0].width=e;r[0].height=t},applyWatermark=function(e){setCanvasSize(e[0].naturalWidth,e[0].naturalHeight);i.drawImage(e[0],0,0,e[0].naturalWidth,e[0].naturalHeight);var t=l,n=0,s=0;if(t.indexOf("top")!=-1)s=10;else s=r.height()/1.2;if(t.indexOf("left")!=-1)n=10;else n=r.width()/1.6;i.drawImage(f[0],n,s,r.width()/3,r.height()/8);e[0].onload=null;e.attr("src",r[0].toDataURL())},getBrightness=function(e){var t=new Image;t.src=e.context.currentSrc;var n=0;var r=document.createElement("canvas");r.width=t.width;r.height=t.height;var i=r.getContext("2d");i.drawImage(t,0,0);var s=i.getImageData(0,0,r.width,r.height);var o=s.data;var u,a,f,l;for(var c=0,h=o.length;c<h;c+=4){u=o[c];a=o[c+1];f=o[c+2];l=Math.floor((u+a+f)/3);n+=l}var p=Math.floor(n/(t.width*t.height));return p},applyWatermarks=function(){setTimeout(function(){var t=e("."+o);var n=0;t.each(function(){var t=e(this);if(getBrightness(t)<100)f=e("#"+u);else f=e("#"+a);d();if(t[0].tagName.toUpperCase()!="IMG")return;if(!t[0].complete){t[0].onload=function(){applyWatermark(t)}}else{applyWatermark(t)}})},10)};v(t)}})(jQuery)