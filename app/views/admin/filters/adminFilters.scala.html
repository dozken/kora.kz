
@main("Фильтры") {

<style>
.modal-dialog{
	width: 300px;
}
[data-bb-handler="confirm"]	{
	
}
</style>

<div class="container">
<div class="col-lg-3 menudiv" >@profile._menu()</div>
<div class="col-lg-9 ">
  @profile._title("ФИЛЬТРЫ"){ }
  @_filters()
</div>

</div>
}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src='@routes.Assets.at("javascripts/gmaps.js")' type="text/javascript"></script>
<script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script src='@routes.Assets.at("javascripts/bootbox.js")'></script>
<script>

bootbox.setDefaults({
	  
	  locale: "ru_delete",
	  show: true,
	  backdrop: true,
	  closeButton: false,
	  animate: true,
	  className: "my-modal"
	  //className: "warning"
});

$(document).ajaxSuccess(function() {
	console.log( "Triggered ajaxSuccess handler." );

	setTimeout(function() {
		$(".alert-dismissable").fadeTo(500, 0).slideUp(500, function(){
			$(this).remove();
		});
	}, 1500);
	$('.city.map').popover({
    	html:true,
    	placement:'right',
    	title: $(this).val(),
    	content:'<div id="globus" style="width:521px;height: 521px"></div>'});
});



//City crud
$(document).on("change", ".animal.select", function(e) {
    var val = $(this).val();
    jsRoutes.controllers.Filters.getBreeds(val).ajax({
        success: function(data) {
            $("#breedList").hide();
            $("#breedList").html(data);
            $("#breedList").slideDown();
            $("#breeds").slideDown();
        },
    });
});

$(document).on("click", ".breed.add", function(e) {
    e.preventDefault();
    jsRoutes.controllers.Filters.addBreed().ajax({
        data: $("#breedForm").serialize(),
        success: function(data) {
            $("#breedList").html(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.responseText);
        }
    });
});

$(document).on("click", ".breed.update", function(e) {
    e.preventDefault();
    var val = $("input[breed=" + $(this).attr("breed") + "]").val();
    var before = $("input[breed=" + $(this).attr("breed") + "]").attr("before");    
    if(val!=before)
    jsRoutes.controllers.Filters.updateBreed($(this).attr("breed"), val).ajax({
        success: function(data) {
            $("#breedList").html(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.responseText);
        }
    });
});
$(document).on("click", ".breed.delete", function(e) {
    e.preventDefault();
    var breed = $(this).attr("breed");    
    bootbox.confirm("Вы уверены?", function(confirm) {
    	if(confirm)
        jsRoutes.controllers.Filters.deleteBreed(breed).ajax({
            success: function(data) {
              $("#breedList").html(data);
            },
            error: function(jqXHR, textStatus, errorThrown) {
              $("#breedList").html(data);
              //console.log(jqXHR.responseText);
            }
        });
    });
    $('[data-bb-handler="confirm"]').toggleClass("btn-primary btn-success")
});

//region crud
$(document).on("click", ".region.add", function(e) {
    e.preventDefault();
    jsRoutes.controllers.Filters.addRegion().ajax({
        data: $("#regionForm").serialize(),
        success: function(data) {
            $("#regionList").html(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.responseText);
        }
    });
});
$(document).on("click", ".region.update", function(e) {
    e.preventDefault();
    
    var val = $("input[region=" + $(this).attr("region") + "]").val();
    var before = $("input[region=" + $(this).attr("region") + "]").attr("before");    
    if(val!=before)
    jsRoutes.controllers.Filters.updateRegion($(this).attr("region"), val).ajax({
        success: function(data) {
            $("#regionList").html(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.responseText);
        }
    });
});
$(document).on("click", ".region.delete", function(e) {
    e.preventDefault();
    var region = $(this).attr("region");    
    bootbox.confirm("Вы уверены?", function(confirm) {
    	if(confirm)
        jsRoutes.controllers.Filters.deleteRegion(region).ajax({
            success: function(data) {
              $("#regionList").html(data);
            },
            error: function(jqXHR, textStatus, errorThrown) {
              $("#regionList").html(data);
              //console.log(jqXHR.responseText);
            }
        });
    });
    $('[data-bb-handler="confirm"]').toggleClass("btn-primary btn-success")
});


///city crud
$(document).on("change", ".region.select", function(e) {
    var val = $(this).val();
    jsRoutes.controllers.Filters.getCities(val).ajax({
        success: function(data) {
            $("#cityList").hide();
            $("#cityList").html(data);
            $("#cityList").slideDown();
            $("#cities").slideDown();
        },
    });
});

$(document).on("change", "#region", function() {
    var id = Number($(this).val());
    jsRoutes.controllers.Filters.getParentCities(id).ajax({
        success: function(data) {
            $("#city_list").html(data);
        }
    });
});

$(document).on("click", ".city.add", function(e) {
    e.preventDefault();
    jsRoutes.controllers.Filters.addCity().ajax({
        data: $("#cityForm").serialize(),
        success: function(data) {
            $("#cityList").html(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.responseText);
        }
    });
});

$(document).on("click", ".city.update", function(e) {
    e.preventDefault();
    var val = $("input[city=" + $(this).attr("city") + "]").val();
    var before = $("input[city=" + $(this).attr("city") + "]").attr("before");   
    var latlng = $("input[city=" + $(this).attr("city") + "]").attr("latlng");
    //if(val!=before)
    jsRoutes.controllers.Filters.updateCity($(this).attr("city"), val,latlng).ajax({
        success: function(data) {
            $("#cityList").html(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR.responseText);
        }
    });
});
$(document).on("click", ".city.delete", function(e) {
    e.preventDefault();
    var city = $(this).attr("city");    
    bootbox.confirm("Вы уверены?", function(confirm) {
    	if(confirm)
        jsRoutes.controllers.Filters.deleteCity(city).ajax({
            success: function(data) {
              $("#cityList").html(data);
            },
            error: function(jqXHR, textStatus, errorThrown) {
              $("#cityList").html(data);
              //console.log(jqXHR.responseText);
            }
        });
    });
    $('[data-bb-handler="confirm"]').toggleClass("btn-primary btn-success")
});

var myMap;
$(document).on("click", ".mapSelect", function() {
    if ($(this).attr("map") == "yandex") {
    	ymaps.ready(init);
    	
    	var myPlacemark;

    	function init() {
    	    myMap = new ymaps.Map("mapDiv", {
    	        center: [43.237887, 76.927437],
    	        controls: ["zoomControl"],
    	        zoom: 16
    	    });
    	    myPlacemark = new ymaps.Placemark([43.237887, 76.927437], {
	            content: 'Алматы',
	            balloonContent: 'Алматы'
	        });
    	    
    	    myMap.geoObjects.add(myPlacemark);
    	    myMap.events.add('click', function(e) {

    	        myMap.geoObjects.remove(myPlacemark);

    	        var coords = e.get('coords');
    	        $("#location").val(coords);
    	        myPlacemark = new ymaps.Placemark(coords, {
    	            content: '<p>' + $("#city").val() + '</p>',
    	            balloonContent: '<p>' + $("#city").val() + '</p>'
    	        });
    	        
    	        myMap.geoObjects.add(myPlacemark);
    	    });
    	}
    }
    if ($(this).attr("map") == "google"){
    	//gmap
    	var myGmap = new GMaps({
    	    div: '#mapDiv',
    	    zoom: 14,
    	    lat: "43.276978",
    	    lng: "76.893096",
    	    click: function(e) {
    	        $("#location").val(e.latLng);
    	        myGmap.removeMarker(myMap);
    	        myMap = myGmap.addMarker({
    	            position: e.latLng,
    	            infoWindow: {
    	                content: '<p>' + $("#city").val() + '</p>'
    	            }
    	        });
    	    },
    	});
    }
});



$(document).on("click", ".city.map", function(e) {
    e.preventDefault();
    
    //$(this).popover("show");
    var city = $(this).attr("city");
    var latVal = $(this).attr("lat");
    var lngVal = $(this).attr("lng");
    var that =  $("input[city=" + $(this).attr("city") + "]");
    console.log(that)
    console.log(latVal)
    console.log(lngVal)
    
    var map;
    var myGmap = new GMaps({
	    div: '#globus',
	    zoom: 14,
	    lat: latVal,
	    lng: lngVal,
	    click: function(e) {
	        $(that).attr("latlng",e.latLng);
	        myGmap.removeMarker(map);
	        map = myGmap.addMarker({
	            position: e.latLng,
	            infoWindow: {
	                content: '<p>' + $(that).val() + '</p>'
	            }
	        });
	        $(this).popover("hide");
	    },
	});
});





</script>
