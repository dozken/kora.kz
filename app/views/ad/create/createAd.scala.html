@(user:models.user.AuthorisedUser)
@lat = {@if(user!=null && user.location!=null){@user.location.lat} else{43.237887}}
@lng = {@if(user!=null && user.location!=null){@user.location.lng}else{76.927437}}
@main("Подать объявление") {
<script src='@routes.WebJarAssets.at(WebJarAssets.locate("jquery-ui.min.js"))' type="text/javascript"></script>
<script>
    /*** Handle jQuery plugin naming conflict between jQuery UI and Bootstrap ***/
    $.widget.bridge('uibutton', $.ui.button);
    $.widget.bridge('uitooltip', $.ui.tooltip);
</script>
<style>
    .ui-state-highlight {
        display: inline-block;
        height: 100px;
        width: 100px;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    .clear {
        clear: both;
    }
    .custom-tooltip + .tooltip > .tooltip-inner {
        background-color: #E0E0E0;
        max-width: 100%; width: 100%;
        color:black;
    }
    .custom-tooltip + .tooltip > .tooltip-arrow {border-top-color:#E0E0E0	; }
</style>
<link rel="stylesheet" media="screen" href='@routes.WebJarAssets.at(WebJarAssets.locate("css/font-awesome.min.css"))'>
<div class="container сontain">
    <div class="searchbarmargin">@_searchbar()</div>
    <div id="create-form">
        @_form(user)
    </div>
</div>
}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src='@routes.Assets.at("javascripts/gmaps.js")' type="text/javascript"></script>
<script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>


<script type="text/javascript" src="@routes.Application.javascriptRoutes"></script>
<script>

    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip()
    });

    $("#next").click(function() {
        if (validation("next")) {
            $("#ad_info").slideUp();
            $("#contact_info").slideDown();
        }
    });

    $("#back").click(function() {
        $("#contact_info").slideUp();
        $("#ad_info").slideDown();
    });

    $("#error_fields").hide();
    $("#error_fields").css("visibility", "none");
    $("#success_message").hide();
    $("#success_message").css("visibility", "none");
    $("#tel1").mask("+7(999) 999-9999");
</script>

<script>
    var quan = $("#quanHide").html();
    var gender = $("#genderHide").html();
    var age = $("#ageHide").html();
    var title = $("#titleHide").html();

    $(document).ready(function(){

        $("#titleHide").empty();
    });
    $(document).on("change", "[name='payment_type']", function() {
        if ($(this).val() == "normal") {
            $("#money_input").attr("validation", "number");
        } else {
            $("#money_input").attr("validation", "");
        }
    });

    var imageMap = {};
    // add a item
    //map[key1] = value1;
    // or remove it
    //delete map[key1];
    // or determine whether a key exists
    //key1 in map;
    $("#images").sortable({
        placeholder: 'ui-state-highlight'
    });

    var choose = document.getElementById('choose');
    FileAPI.event.on(choose, 'change', function(evt) {
        var files = FileAPI.getFiles(evt); // Retrieve file list

        FileAPI.filterFiles(files, function(file, info /**Object*/ ) {
            if (/^image/.test(file.type)) {
                if (info.width >= 320 && info.height >= 240) return true;
                else alert("Размер фото слишком маленький");
            } else {
                alert("Можно загрузить только фото");
                return false;
            }
        }, function(files /**Array*/ , rejected /**Array*/ ) {
            if (files.length + $("#images li").length <= 5) {
                FileAPI.each(files, function(file) {
                    FileAPI.Image(file).preview(400).get(function(err, img) {
                        var imgName = file.name.replace(/ /g, '');
                        imageMap[imgName] = img.toDataURL("image/jpeg");
                    });
                    FileAPI.Image(file).preview(100).get(function(err, img) {
                        var name = file.name.replace(/\./g, '');
                        name = name.replace(/ /g, '');
                        if ($('[id=item-' + name + ']').length == 0) {
                            $("#images").append("<li id=item-" + name + " fileName='" + file.name.replace(/ /g, '') + "' style='position:relative; display: inline-block;margin-right: 10px; margin-bottom: 10px;width: 100px; height: 100px;'></li>");
                            $("#item-" + name).html(img);
                            $("#item-" + name).append('<a class="delete" style="position: absolute;top: 4px;right: 3px;height: 12px;width: 12px;border-radius: 50px;background: white;"> <i class="fa fa-times-circle" style="font-size:17px;color:#ab2341;position: absolute;top: -3px;right: -1px;"></i></a>');

                        } else {
                            alert(name + " уже есть");
                        }
                    });
                });
            } else {
                alert("Максимальное количество фото 5");
            }
        });
    });

    $(document).on("click", ".delete", function() {
        $(this).parent().remove();
    });

    $(document).on("click", "#add_phone_additional", function() {
        if($('.additional-phone').length<3){
            $("#additional_phones").append('<div class="input-group additional-phone"><input type="text" placeholder="" class="form-control input-md ssss mmm"><span class="input-group-btn"><a class="del_phone" style="padding-left: 5px;"><i class="fa fa-times-circle" style="font-size:17px;color:#ab2341;"></i></a></span></div>');
            $(".mmm").mask("+7(999) 999-9999");
        }
    });
    $(document).on("click", ".del_phone", function() {
        $(this).parent().parent().remove();

    });

    $(document).on("change", "#section", function() {
        var id = Number($(this).val());

        if(id==5){
            $("#quanHide").empty();
            $("#genderHide").empty();
            $("#ageHide").empty();
            $("#titleHide").html(title);
        }else{
            $("#titleHide").empty();
            $("#quanHide").html(quan);
            $("#genderHide").html(gender);
            $("#ageHide").html(age);
        }

        jsRoutes.controllers.Ads.getCategories(id).ajax({
            success: function(data) {
                $("#category_list").html(data);
            }
        });
    })

    $(document).on("change", "#region", function() {
        var id = Number($(this).val());
        jsRoutes.controllers.Ads.getCities(id).ajax({
            success: function(data) {
                $("#city_list").html(data);
            }
        });
    });

    $(document).on("click", "#ad_form_submit", function(e) {
        //var $btn = $("#ad_form_submit").button('loading');

        //e.preventDefault();
        if (validation("reg2")) {

            var tels = "";
            $("#additional_phones input").each(function(){

                if($(this).val()!=null && $(this).val()!=""){
                    tels+="," + $(this).val();
                }
            })

            $("#tels").val(tels);
            $('#ad_form').submit(function(e) {
                var formData = new FormData(this);
                var image_names = "";
                $("#images li canvas").each(function() {
                    var a = imageMap[$(this).parent().attr("fileName")];
                    formData.append($(this).parent().attr("fileName"), a);
                    image_names += $(this).parent().attr("fileName") + "&";
                });
                formData.append("image_names", image_names);


                $("#ad_form_submit").attr('disabled','disabled');
                $("#ad_form_submit").text('Загружается...');

                var start = +new Date();  // log start timestamp

                $.ajax({
                    url: '@controllers.routes.Ads.create',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {


                        var end =  +new Date();  // log end timestamp
                        var diff = end - start;

                         $("#success_message").html("Вы успешно подали объявление. Дополнительная информация выслана на ваш email!!!");
                         $("#success_message").fadeIn(2000);

                        $("#create-form").html(data);


                         jsRoutes.controllers.Application.emailing("ad_created", $("#ema").val()).ajax()

                        var end2 =  +new Date();  // log end timestamp
                        var diff1 = end2 - end;

                        setTimeout(function() {
                            @if(session.get("connected") != null){
                                window.location.href = "@routes.Manage.myAds()";
                            }else{
                                window.location.href = "@routes.Application.index()";
                            }
                        }, 1000);



                    }
                });
                e.preventDefault();
            });
        } else {
            e.preventDefault();
            $("#error_fields").html("");
            $("#error_fields").append("Некоторые поля заполнены неправильно");
            $("#error_fields").show();
            window.scrollTo(0, 0);
        }
    });

    var lat = "@lat";
    var lng = "@lng";
    var marker;
    var myPlacemark;
    var isMarker = false;
    var curMap = "google";
    var myCollection;

    $(document).on("click","#remove-map-marker",function(){
        marker.setMap(null);
        $("#location").val("");
        myMap.geoObjects.remove(myPlacemark);
        myCollection.removeAll();
    });
    $(document).on("change", "#city", function() {
        lat = $('option:selected', this).attr('lat');
        lng = $('option:selected', this).attr('lng');
        isMarker = false;
        if (curMap == "yandex") {
            $("#mouse_event_map").html("");
            myMap = new ymaps.Map("mouse_event_map", {
                center: [lat, lng],
                zoom: 14,
                controls: ["zoomControl"]
            });

            new ymaps.GeoObjectCollection({}, {
                preset: 'twirl#redIcon', //all placemarks are red
                draggable: true // and can be dragged
            });
            myMap.events.add('click', function(e) {
                lat = e.get('coords')[0];
                lng = e.get('coords')[1];
                isMarker = true;
                myCollection = new ymaps.GeoObjectCollection({}, {
                    preset: 'twirl#redIcon', //all placemarks are red
                    draggable: true // and can be dragged
                });
                myCollection.removeAll();
                myMap.geoObjects.remove ( myPlacemark ) ;
                myMap.geoObjects.removeAll();
                var coords = e.get ( 'coords' ) ;
                myPlacemark = new ymaps.Placemark ( coords) ;
                myCollection.add(myPlacemark)
                myMap.geoObjects.add(myCollection);
                $ ( "#location" ).val ("("+lat+","+lng+")") ;
            });
        } else {
            map = new GMaps({
                div: '#mouse_event_map',
                zoom: 14,
                lat: lat,
                lng: lng,
                width: '650px',
                height: '400px',
                click: function(e) {
                    $("#location").val(e.latLng);
                    lat = e.latLng.lat();
                    lng = e.latLng.lng();
                    isMarker = true;
                    map.removeMarker(marker);
                    marker = map.addMarker({
                        position: e.latLng
                    });
                }
            });
        }
    });

    $(document).on("click", ".mapSelect", function() {
        if ($(this).attr("map") == "yandex") {
            curMap = "yandex";
            myMap = new ymaps.Map("mouse_event_map", {
                center: [lat, lng],
                zoom: 14,
                controls: ["zoomControl"]
            });
            myMap.events.add('click', function(e) {

                lat = e.get('coords')[0];
                lng = e.get('coords')[1];
                isMarker = true;

                myCollection = new ymaps.GeoObjectCollection({}, {
                    preset: 'twirl#redIcon', //all placemarks are red
                    draggable: true // and can be dragged
                });
                myCollection.removeAll();
                myMap.geoObjects.remove ( myPlacemark ) ;
                myMap.geoObjects.removeAll();
                myCollection.removeAll();
                var coords = e.get ( 'coords' ) ;
                myPlacemark = new ymaps.Placemark ( coords) ;
                myCollection.add(myPlacemark)
                myMap.geoObjects.add(myCollection);
                $ ( "#location" ).val ("("+lat+","+lng+")") ;
            });
            if (isMarker) {
                myPlacemark = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: [lat, lng]
                    }
                });
                myMap.geoObjects.add(myPlacemark);
            }
        } else {
            curMap = "google";
            map = new GMaps({
                div: '#mouse_event_map',
                zoom: 14,
                lat: lat,
                lng: lng,
                width: '650px',
                height: '400px',
                click: function(e) {
                    $("#location").val(e.latLng);
                    lat = e.latLng.lat();
                    lng = e.latLng.lng();
                    isMarker = true;
                    map.removeMarker(marker);
                    marker = map.addMarker({
                        position: e.latLng
                    });
                }
            });
            if (isMarker) {
                map.removeMarker(marker);
                marker = map.addMarker({
                    lat: lat,
                    lng: lng,
                });
            }
        }
    });
</script>

<script type="text/javascript">
    $(document).ready(function() {
        map = new GMaps({
            div: '#mouse_event_map',
            zoom: 14,
            lat: lat,
            lng: lng,
            width: '650px',
            height: '400px',
            click: function(e) {
                $("#location").val(e.latLng);
                lat = e.latLng.lat();
                lng = e.latLng.lng();
                isMarker = true;
                map.removeMarker(marker);
                marker = map.addMarker({
                    position: e.latLng
                });
            }
        });
        @if(user != null && user.location != null){
            marker = map.addMarker({
                lat: lat,
                lng: lng
            });
            isMarker = true;
        }
    });
</script>