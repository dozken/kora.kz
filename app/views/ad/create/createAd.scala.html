@(user:models.user.AuthorisedUser)
@lat = {@if(user!=null && user.location!=null){@user.location.lat} else{43.237887}}
@lng = {@if(user!=null && user.location!=null){@user.location.lng}else{76.927437}}
@main("Подать объявление") {
<style>
.ui-state-highlight {
display: inline-block;
height: 100px;
width: 100px;
margin-right: 10px;
margin-bottom: 10px;
}
.clear {
clear: both;
}
</style>
<link rel="stylesheet" media="screen" href='@routes.WebJarAssets.at(WebJarAssets.locate("css/font-awesome.min.css"))'>
<div class="container сontain">
	<div class="searchbarmargin">@_searchbar()</div>
	@_form(user)
</div>
}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src='@routes.Assets.at("javascripts/gmaps.js")' type="text/javascript"></script>
<script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script src='@routes.WebJarAssets.at(WebJarAssets.locate("jquery-ui.min.js"))' type="text/javascript"></script>
<script type="text/javascript" src="@routes.Application.javascriptRoutes"></script>
<link rel="stylesheet" href='@routes.Assets.at("javascripts/jquery.ui.plupload/css/jquery.ui.plupload.css")' type="text/css" media="screen" />
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css" type="text/css" />
<script src='@routes.Assets.at("javascripts/plupload.full.min.js")' type="text/javascript"></script>
<script src='@routes.Assets.at("javascripts/jquery.ui.plupload/jquery.ui.plupload.js")' type="text/javascript"></script>
<script src='@routes.Assets.at("javascripts/jquery.ui.plupload/ru.js")' type="text/javascript"></script>



<script>
    $("#next").click(function() {
        if (validation("next")) {
            $("#ad_info").slideUp();
            $("#contact_info").slideDown();
        }
    });

    $("#back").click(function() {
        $("#contact_info").slideUp();
        $("#ad_info").slideDown();
    });

    $("#error_fields").hide();
    $("#error_fields").css("visibility", "none");
    $("#success_message").hide();
    $("#success_message").css("visibility", "none");
    $("#tel1").mask("+7(999) 999-9999");
</script>

<script>
var quan = $("#quanHide").html();
var gender = $("#genderHide").html();
var age = $("#ageHide").html();		
var title = $("#titleHide").html();
	$(document).ready(function(){
		
        $("#titleHide").empty();
	});
    $(document).on("change", "[name='payment_type']", function() {
        if ($(this).val() == "normal") {
            $("#money_input").attr("validation", "number");
        } else {
            $("#money_input").attr("validation", "");
        }
    });


    $(document).on("click", "#add_phone_additional", function() {
        $("#additional_phones").append('<div class="input-group"><input type="text" placeholder="" class="form-control input-md ssss mmm"><span class="input-group-btn"><a class="del_phone" style="padding-left: 5px;"><i class="fa fa-times-circle" style="font-size:17px;color:#ab2341;"></i></a></span></div>');
        $(".mmm").mask("+7(999) 999-9999");

    });

    $(document).on("click", ".del_phone", function() {
      $(this).parent().parent().remove();

    });

    $(document).on("change", "#section", function() {
        var id = Number($(this).val());
        console.log(id);
        
        if(id==5){
        	$("#quanHide").empty();
            $("#genderHide").empty();
            $("#ageHide").empty();	
            $("#titleHide").html(title);            
        }else{
        	$("#titleHide").empty();
        	$("#quanHide").html(quan);
            $("#genderHide").html(gender);
            $("#ageHide").html(age);
        }
        
        jsRoutes.controllers.Ads.getCategories(id).ajax({
            success: function(data) {
                $("#category_list").html(data);
            }
        });
    })

    $(document).on("change", "#region", function() {
        var id = Number($(this).val());
        jsRoutes.controllers.Ads.getCities(id).ajax({
            success: function(data) {
                $("#city_list").html(data);
            }
        });
    });


    $(document).on("click", "#ad_form_submit", function(e) {
        var start =  +new Date();
        if (validation()) {
            var tels = "";
            $("#additional_phones input").each(function () {
                if ($(this).val() != null && $(this).val() != "") {
                    tels += "," + $(this).val();
                }
            });
            $("#tels").val(tels);
            $("#ad_form_submit").attr('disabled', 'disabled');
            $("#ad_form_submit").text('Загружается...');

            jsRoutes.controllers.Ads.create().ajax({
                data: $("#ad_form").serialize(),
                success: function (data) {
                    $("#success_message").html("Вы успешно подали объявление. Дополнительная информация выслана на ваш email!!!");
                    $("#success_message").fadeIn(200);
                    var end =  +new Date();  // log end timestamp
                    var diff = end - start;
                    console.log(diff);
                    @if(session.get("connected") != null) {
                        window.location.href = "@routes.Manage.myAds()";
                    }else{
                        window.location.href = "@routes.Application.index()";
                    }
                }
            });
            e.preventDefault();
        }else{
            e.preventDefault();
            $("#error_fields").html("");
            $("#error_fields").append("Некоторые поля заполнены неправильно");
            $("#error_fields").show();
            window.scrollTo(0, 0);
        }
    });

    var lat = "@lat";
    var lng = "@lng";
    var marker;
    var myPlacemark;
    var isMarker = false;
    var curMap = "google";
    var myCollection;
    
	$(document).on("click","#remove-map-marker",function(){
		marker.setMap(null);
		$("#location").val("");		
		myMap.geoObjects.remove(myPlacemark);
		myCollection.removeAll();
	});
    $(document).on("change", "#city", function() {
        lat = $('option:selected', this).attr('lat');
        lng = $('option:selected', this).attr('lng');
        isMarker = false;
        if (curMap == "yandex") {
            $("#mouse_event_map").html("");
            myMap = new ymaps.Map("mouse_event_map", {
                center: [lat, lng],
                zoom: 14,
                controls: ["zoomControl"]
            });
            
             new ymaps.GeoObjectCollection({}, {
			preset: 'twirl#redIcon', //all placemarks are red
			draggable: true // and can be dragged
		});
            myMap.events.add('click', function(e) {
                lat = e.get('coords')[0];
                lng = e.get('coords')[1];
                isMarker = true;
 				myCollection = new ymaps.GeoObjectCollection({}, {
					preset: 'twirl#redIcon', //all placemarks are red
					draggable: true // and can be dragged
				});
				myCollection.removeAll();
				myMap.geoObjects.remove ( myPlacemark ) ;
				myMap.geoObjects.removeAll();
				var coords = e.get ( 'coords' ) ;
				myPlacemark = new ymaps.Placemark ( coords) ;		
				myCollection.add(myPlacemark)
				myMap.geoObjects.add(myCollection);
				$ ( "#location" ).val ("("+lat+","+lng+")") ;
            });
        } else {
            map = new GMaps({
                div: '#mouse_event_map',
                zoom: 14,
                lat: lat,
                lng: lng,
                width: '650px',
                height: '400px',
                click: function(e) {
                    $("#location").val(e.latLng);
                    lat = e.latLng.lat();
                    lng = e.latLng.lng();
                    isMarker = true;
                    map.removeMarker(marker);
                    marker = map.addMarker({
                        position: e.latLng
                    });
                }
            });
        }
    });

    $(document).on("click", ".mapSelect", function() {
        if ($(this).attr("map") == "yandex") {
            curMap = "yandex";
            myMap = new ymaps.Map("mouse_event_map", {
                center: [lat, lng],
                zoom: 14,
                controls: ["zoomControl"]
            });
            myMap.events.add('click', function(e) {

                lat = e.get('coords')[0];
                lng = e.get('coords')[1];
                isMarker = true;
                
                myCollection = new ymaps.GeoObjectCollection({}, {
					preset: 'twirl#redIcon', //all placemarks are red
					draggable: true // and can be dragged
				});
				myCollection.removeAll();
				myMap.geoObjects.remove ( myPlacemark ) ;
				myMap.geoObjects.removeAll();
				myCollection.removeAll();
				var coords = e.get ( 'coords' ) ;
				myPlacemark = new ymaps.Placemark ( coords) ;		
				myCollection.add(myPlacemark)
				myMap.geoObjects.add(myCollection);
				$ ( "#location" ).val ("("+lat+","+lng+")") ;
            });
            if (isMarker) {
                myPlacemark = new ymaps.GeoObject({
                    geometry: {
                        type: "Point",
                        coordinates: [lat, lng]
                    }
                });
                myMap.geoObjects.add(myPlacemark);
            }
        } else {
            curMap = "google";
            map = new GMaps({
                div: '#mouse_event_map',
                zoom: 14,
                lat: lat,
                lng: lng,
                width: '650px',
                height: '400px',
                click: function(e) {
                    $("#location").val(e.latLng);
                    lat = e.latLng.lat();
                    lng = e.latLng.lng();
                    isMarker = true;
                    map.removeMarker(marker);
                    marker = map.addMarker({
                        position: e.latLng
                    });
                }
            });
            if (isMarker) {
                map.removeMarker(marker);
                marker = map.addMarker({
                    lat: lat,
                    lng: lng,
                });
            }
        }
    });
</script>

<script type="text/javascript">
    $(document).ready(function() {
        map = new GMaps({
            div: '#mouse_event_map',
            zoom: 14,
            lat: lat,
            lng: lng,
            width: '650px',
            height: '400px',
            click: function(e) {
                $("#location").val(e.latLng);
                lat = e.latLng.lat();
                lng = e.latLng.lng();
                isMarker = true;
                map.removeMarker(marker);
                marker = map.addMarker({
                    position: e.latLng
                });
            }
        });
        @if(user != null && user.location != null){
            marker = map.addMarker({
                lat: lat,
                lng: lng
            });
            isMarker = true;
        }
    });


    $(function() {
        $("#uploader").plupload({
            // General settings
            runtimes : 'html5,flash,silverlight,html4',
            url : '@controllers.routes.Ads.imageUpload',

            // User can upload no more then 5 files in one go (sets multiple_queues to false)
            max_file_count: 5,

            chunk_size: '1mb',

            // Resize images on clientside if we can

            filters : {
                // Maximum file size
                max_file_size : '5mb',
                // Specify what files to browse for
                mime_types: [
                    {title : "Image files", extensions : "jpg,gif,png"}
                ]
            },

            // Rename files by clicking on their titles
            rename: true,

            // Sort files
            sortable: true,

            // Enable ability to drag'n'drop files onto the widget (currently only HTML5 supports that)
            dragdrop: false,

            // Views to activate
            views: {
                list: true,
                thumbs: true, // Show thumbs
                active: 'thumbs'
            },

            // Flash settings
            flash_swf_url : '../../js/Moxie.swf',

            // Silverlight settings
            silverlight_xap_url : '../../js/Moxie.xap'
        });

        // Handle the case when form was submitted before uploading has finished
    });

</script>